{% extends 'base.html' %}
{% block content %}
{% csrf_token %}
{% include 'navbar.html' %}

<div class="mt-24 container mx-auto p-6">
    <div class="bg-white shadow-lg rounded-lg p-6">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">My Jobs</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Order Date</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for order in orders %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ order.orderdate|date:"M d, Y" }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ order.service_name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ order.customer_name }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${{ order.totalprice }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                                {% if order.status == 'Waiting for Payment' %}bg-yellow-100 text-yellow-800
                                {% elif order.status == 'Service in Progress' %}bg-blue-100 text-blue-800
                                {% elif order.status == 'Order Completed' %}bg-green-100 text-green-800
                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                {{ order.status }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">
                            {% if order.status != 'Order Completed' and order.status != 'Cancelled' %}
                            <select 
                                onchange="updateOrderStatus('{{ order.id }}', this.value)"
                                class="rounded-md border-gray-300 shadow-sm focus:border-yellow-500 focus:ring focus:ring-yellow-200 focus:ring-opacity-50">
                                <option value="" disabled selected>Update Status</option>
                                <option value="Waiting for Worker to Depart">Ready to Depart</option>
                                <option value="Worker Arrived at Location">Arrived at Location</option>
                                <option value="Service in Progress">Start Service</option>
                                <option value="Waiting for Payment">Complete Service</option>
                            </select>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>

<script>
async function updateOrderStatus(orderId, newStatus) {
    try {
        const response = await fetch("{% url 'main:update_order_status' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                order_id: orderId,
                status: newStatus
            })
        });

        const data = await response.json();
        
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.message || 'Failed to update status');
        }
    } catch (error) {
        alert('Error updating status: ' + error.message);
    }
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% include 'footer.html' %}
{% endblock content %}
